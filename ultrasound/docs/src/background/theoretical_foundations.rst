.. 
   Copyright 2019 Xilinx, Inc.
  
   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at
  
       http://www.apache.org/licenses/LICENSE-2.0
  
   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

Theoretical foundations
=======================

.. toctree::
   :hidden:
   :maxdepth: 1

Introduction
------------
This section explains the theory behind the libraries and the possible range of applications.

This beamformer works with 3D data inputs axial, lateral and elevation, captured from ultrasound transducers to produce a visible image of the region impinged by ultrasonic waves. There are two modalities specific to this library: 

Synthetic Aperture Imaging (SA), and Plane Wave Imaging (PW).

The beamformer however can be used with other imaging technique such as flow imaging.

In ultrasound medical imaging, beamforming captures the spatial distribution of the acoustic wave pressure field amplitude in the volume of interest elaborating the signals generated by an ultrasonic transducer, reflected by an anatomic part as scattered waves, and received by the same ultrasonic transducer for the purpose of generating images.

There are several parameters that affect the final image quality:

Spatial resolution: the smallest spatial distance for which two scatterers can be distinguished in the final image. Spatial resolution can either be axial (along the direction of propagation of the ultrasound wave), lateral, or elevation resolution (along the plane to which the direction of propagation is perpendicular). This feature is normally expressed in mm.

Temporal resolution: the time interval between two consecutive images. This feature is normally expressed in Hz.

Contrast: the capability to visually delineate different objects, e.g., different tissue types, in the generated images. This feature is generally expressed in dB, and it is a relative measure between image intensities.

Penetration depth: the larger depths for which a sufficiently high signal-to-noise ratio (SNR) level can be maintained. This feature is normally expressed in cm.

Array aperture: the physical sizes of the surface representing the combined distribution of active and passive ultrasound sensors: in other words, the array footprint. The array aperture is defined by the number of ultrasound sensors (elements), their sizes, and their distribution. This feature is generally expressed in cm2.

Field of view (FOV): the sizes of the area represented by the obtained images. This feature is generally expressed in cm2 or cm3

All such features are correlated and interdependent.

Synthetic Aperture
------------------

Synthetic aperture techniques were originally conceived for radar systems. There are many similarities between radar and ultrasound systems, but there are also very significant differences.

SA radar systems usually employ one transmitter and receiver, and the aperture in synthesized by moving the antenna over the region of interest in an airplane or satellite.

In medical ultrasound, the array has a fixed number of elements and is usually stationary.

For radar, the object is most often in the far-field of the array.

For a medical ultrasound system, the object is always in the near field of the array, which complicates the reconstruction.

Since the medical array is stationary, it is possible to repeat measurements rapidly, which is not the case for a SA radar system. The position between the different elements is also fixed in ultrasound, whereas the deviations from a straight flight path for airplane often must be compensated for in radar systems. A vital difference is also that the dynamic range in a Radar image is significantly less than the 40â€“80 dB dynamic range in ultrasound images.

SA technique excites one (or more) transducers to emit an unfocused spherical wave covering the full image region. The received signals for all or part of the elements in the aperture are sampled for each transmission. This data is used for making a low-resolution image (LRI) from the received radio-frequency data (RF-data) and is then obtained by the value registered by all the transducers available in the ultrasound probe. LRI is a noisy image and to improve the image quality SA performs multiple emissions to obtain a corresponding set of LRIs. For example, if the SA performs 7 emissions, then the beamformer must create 7 LRIs. The LRIs received must be compounded in a single image, creating a high-resolution image (HRI). Higher the number of emissions higher the quality of the image, until an SNR limit is reached beyond that there is no perceived quality improvement. The HRI image is then displayed on a healthcare monitor. Every HRI created is counted as a frame in this imaging technique. To be clearer, if we need 30 FPS, then we must create 30 HRIs every second. To bind this concept with the LRIs, if we perform 7 emissions per HRI, with a fixed frame rate of 30 FPS, we will need to perform 7 emissions per frame and so we will need to create 7*30=210 LRIs. The LRIs are going then to be compounded by groups of 7, every 1/30 seconds, to achieve the fixed frame rate of 30fps.

Plane Wave
----------

In the previous paragraph we have seen the basic formulation of SA. It is very important to highlight that PW is a different imaging technique but with the same expected outcome for the process of beamformation. PW imaging, as against SA imaging, excites all the transducers in the same moment to emit a plane wave, whose echoes are registered by all the transducers in our probe. In PW we call emission a single process of excitement of the whole transducers in the probe. As it happens in SA, every emission produces a LRI by the process of beamformation. An HRI could be obtained by compounding a set of LRIs. To have multiple emissions, we use a parameter called span which represents an "aperture" angle and the directions in which we want to emit our plane waves. The span represents the total aperture of the investigation, and to determine the number of emissions and the directions, we use an increment parameter. This represents how many areas with respect to the total angle we want to explore. Let be clearer by providing a practical example. Let us suppose we want to perform 8 emissions with a spanning angle of 30 degrees. The investigations would then be 8, starting from emitting a plane wave with direction of 0 degrees (or -15, depending on the system coordinates) and creating a LRI from the beamformer. The second investigation would be an emission at 3.75 degrees direction (or -11.25, depending on the system coordinates) which is 0+3.75, where 3.75 represents our increment with respect to the emission made. We obtain then a second LRI from the Beamformer. This process is repeated until the 8th emission, and then the 8 LRIs obtained is compounded in a single HRI, same as SA. PW is, in terms of frame rate, the best choice for the process of beamformation. Unlike SA, which needs a high number of emissions, PW could be performed by a single emission (at the cost of having an enormous load in terms data processing), because it excites all (or nearly all) the transducers at the same moment.

The differences between SA and PW
---------------------------------

In the previous chapter, we have briefly introduced the two imaging techniques.

Let us bind the concept of the SA formulation. Some transducers (or just one, depending on design choices) are excited. The excitement produces a spherical wave, whose echoes are collected. Then, a second group of transducers are excited, the spherical wave emitted, and the echoes collected. This process is done the number of times we want to generate single LRIs. The emissions drawn in the previous scheme are then collected and compounded together. Due to the nature of this process, the delay of emission can be computed, and every emission can be focused in both transmission and reception. The dynamic focusing in the reception is obtained by combining all the LRIs because the origin of the wave is known as well as the transducer(s) which generates it, so the path Rx-Tx can be calculated. For this reason, due the sequential emission technique of SA, the insonification area created and is focused on the target:

Every line represents the investigation of subgroup of transducer(s), "rectified" in the process of reception thanks to the sequential mode of emissions.

On contrary, PW excites all the elements, as happens in figure 2. The insonification area cannot consequently be focused, and so must it be computed during the process of Beamforming. To eliminate the differences, we need then to perform three operations:

Compute a delay for the reception for the transducers per line
Focus the plane wave emitted on the direction of propagation (in the next pages we are going to introduce the cartesian system of our probe)
Modifying the formulation of the virtual sources to fit a different type of emission
Performing these three operations "rectifies" the insonification by aligning a PW emitted (which covers the overall area of the transducers) and obtains the same result as the SA.

Whether we use SA or PW, there is the necessity to use virtual transmit sources. Virtual transmit sources are a construct which overcome the problem of increasing the SNR parameter in SA while simultaneously increasing the investigation depth. The calculation of the transmitted field is ambiguous if multiple transducers are involved. The emited focal point is then considered as a source of spherical emission itself and the computation of the propagation in transmission is computable by a unique formula. 

In Summary
----------
The formulation of virtual sources is no less important than other parts in the beamforming formulation, as they are fundamental to compute a valid delay time and select the correct samples for the interpolation. Not all the samples are valid, and so we must interpolate just between the indexes of samples that are considered valid. As mentioned earlier, this process is fundamental to increasing the investigation depth and a high signal quality thanks to the higher SNR generated. One third of the beamforming process is in the selection of the samples, and so it is important to understand the aspects of this process.